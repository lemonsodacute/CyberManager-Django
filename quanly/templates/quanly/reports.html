{% extends 'quanly/pos_base.html' %}

{% block title %}Báo Cáo & Lịch Sử Ca{% endblock %}

{% block content %}
<div class="row g-4">
    <!-- Cột Lịch sử ca -->
    <div class="col-lg-5">
        <div class="card shadow-sm">
            <div class="card-header"><h5 class="mb-0">Lịch Sử Ca Làm Việc</h5></div>
            <div class="card-body">
                <form id="filter-form" class="row g-2 mb-3">
                    <div class="col-sm-6"><input type="date" class="form-control form-control-sm" id="start_date"></div>
                    <div class="col-sm-6"><input type="date" class="form-control form-control-sm" id="end_date"></div>
                </form>
                <div id="shift-list" class="list-group" style="max-height: 65vh; overflow-y: auto;">
                    <div class="text-center p-5"><div class="spinner-border"></div></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cột Chi tiết Báo cáo -->
    <div class="col-lg-7">
        <div id="report-detail-panel" class="card shadow-sm position-sticky" style="top: 1.5rem;">
            <!-- Placeholder -->
            <div id="report-placeholder" class="card-body text-center p-5">
                <i class="bi bi-graph-up" style="font-size: 4rem; color: #adb5bd;"></i>
                <h4 class="mt-3">Xem Chi Tiết Báo Cáo</h4>
                <p class="text-muted">Chọn một ca làm việc từ danh sách bên trái để xem báo cáo chi tiết.</p>
            </div>
            
            <!-- Detail View -->
            <div id="report-view" class="d-none">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Báo Cáo Ca: <span id="report-shift-name" class="text-primary"></span></h5>
                    <button class="btn btn-success btn-sm" id="export-shift-excel-btn"><i class="bi bi-file-earmark-excel-fill me-1"></i> Xuất Excel</button>
                </div>
                <div class="card-body" style="max-height: 75vh; overflow-y: auto;">
                    <h6>Tổng Kết Doanh Thu</h6>
                    <div class="row">
                        <div class="col-sm-6"><p class="mb-1"><strong>Tổng tiền giờ:</strong> <span id="report-revenue-time" class="float-end"></span></p></div>
                        <div class="col-sm-6"><p class="mb-1"><strong>Tổng tiền dịch vụ:</strong> <span id="report-revenue-service" class="float-end"></span></p></div>
                        <div class="col-12"><hr class="my-2"><p class="mb-1 fs-5"><strong>Tổng cộng:</strong> <span id="report-revenue-total" class="float-end text-danger fw-bold"></span></p></div>
                    </div>
                    <hr>
                    <h6>Chi Tiết Doanh Thu Dịch Vụ</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-striped">
                            <thead><tr><th>Tên Món</th><th class="text-center">Số Lượng</th><th class="text-end">Doanh Thu</th></tr></thead>
                            <tbody id="report-service-details"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- KHAI BÁO BIẾN ---
    const shiftList = document.getElementById('shift-list');
    const filterForm = document.getElementById('filter-form');
    const reportPlaceholder = document.getElementById('report-placeholder');
    const reportView = document.getElementById('report-view');
    const exportExcelBtn = document.getElementById('export-shift-excel-btn');
    
    let shifts = [];
    let selectedShiftId = null;
    const API_BASE_URL = '/pos/api';

    // --- CÁC HÀM TIỆN ÍCH & API ---
    const formatCurrency = (v) => Math.ceil(v || 0).toLocaleString('vi-VN') + ' VNĐ';

    // --- RENDER ---
    function renderShiftList(data) {
        shiftList.innerHTML = '';
        if (data.length === 0) {
            shiftList.innerHTML = '<p class="text-muted text-center p-4">Không có ca nào.</p>';
            return;
        }
        data.forEach(ca => {
            const isActive = ca.id === selectedShiftId ? 'active' : '';
            shiftList.innerHTML += `
                <a href="#" class="list-group-item list-group-item-action ${isActive}" data-id="${ca.id}">
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">Ca ${ca.loai_ca.ten_ca} - ${new Date(ca.ngay_lam_viec).toLocaleDateString('vi-VN')}</h6>
                        <small>${ca.nhan_vien.tai_khoan}</small>
                    </div>
                    <small>Doanh thu: ${formatCurrency(ca.tong_doanh_thu_he_thong)}</small>
                </a>`;
        });
    }

    async function renderReportDetail(shiftId) {
        if (!shiftId) {
            reportPlaceholder.classList.remove('d-none');
            reportView.classList.add('d-none');
            return;
        }
        reportPlaceholder.classList.add('d-none');
        reportView.classList.remove('d-none');
        document.getElementById('report-service-details').innerHTML = '<tr><td colspan="3" class="text-center"><div class="spinner-border spinner-border-sm"></div></td></tr>';

        try {
            const response = await fetch(`${API_BASE_URL}/bao-cao/ca/${shiftId}/`);
            const data = await response.json();
            
            document.getElementById('report-shift-name').textContent = `${data.loai_ca} - ${new Date(data.ngay_lam_viec).toLocaleDateString('vi-VN')}`;
            document.getElementById('report-revenue-time').textContent = formatCurrency(data.tong_tien_gio);
            document.getElementById('report-revenue-service').textContent = formatCurrency(data.tong_tien_dich_vu);
            document.getElementById('report-revenue-total').textContent = formatCurrency(data.tong_doanh_thu_he_thong);

            const serviceTbody = document.getElementById('report-service-details');
            serviceTbody.innerHTML = '';
            if(data.chi_tiet_dich_vu.length > 0){
                data.chi_tiet_dich_vu.forEach(item => {
                    serviceTbody.innerHTML += `
                        <tr>
                            <td>${item.mon__ten_mon}</td>
                            <td class="text-center">${item.so_luong_ban}</td>
                            <td class="text-end">${formatCurrency(item.doanh_thu)}</td>
                        </tr>`;
                });
            } else {
                serviceTbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">Không có doanh thu dịch vụ trong ca này.</td></tr>';
            }
        } catch (error) {
             document.getElementById('report-service-details').innerHTML = `<tr><td colspan="3" class="text-center text-danger">Lỗi tải chi tiết báo cáo.</td></tr>`;
        }
    }

    // --- LOGIC ---
    async function loadShiftHistory(params = {}) {
        shiftList.innerHTML = '<div class="text-center p-5"><div class="spinner-border"></div></div>';
        const query = new URLSearchParams(params).toString();
        try {
            const response = await fetch(`${API_BASE_URL}/bao-cao/lich-su-ca/?${query}`);
            shifts = await response.json();
            renderShiftList(shifts);
        } catch(error) {
             shiftList.innerHTML = '<p class="text-danger text-center p-4">Lỗi tải lịch sử ca.</p>';
        }
    }

    // --- SỰ KIỆN ---
    filterForm.addEventListener('change', () => { // Lọc ngay khi thay đổi ngày
        const params = {
            start_date: document.getElementById('start_date').value,
            end_date: document.getElementById('end_date').value,
        };
        loadShiftHistory(params);
    });

    shiftList.addEventListener('click', e => {
        e.preventDefault();
        const item = e.target.closest('.list-group-item');
        if (item) {
            selectedShiftId = parseInt(item.dataset.id);
            renderShiftList(shifts);
            renderReportDetail(selectedShiftId);
        }
    });

    exportExcelBtn.addEventListener('click', () => {
        if (!selectedShiftId) {
            alert("Vui lòng chọn một ca để xuất báo cáo.");
            return;
        }
        window.location.href = `${API_BASE_URL}/bao-cao/ca/${selectedShiftId}/xuat-excel/`;
    });

    // --- KHỞI CHẠY ---
    loadShiftHistory();
});
</script>
{% endblock %}