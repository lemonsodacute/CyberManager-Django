{% extends 'quanly/pos_base.html' %}

{% block title %}Kiểm Kê Cuối Ca - Quản Net Pro{% endblock %}

{% block extra_css %}
<style>
    .inventory-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1rem;
    }
    .inventory-card {
        transition: all 0.2s ease-in-out;
        border-left-width: 4px;
    }
    .inventory-card.checked-item {
        background-color: #f8f9fa;
        border-left-color: #198754;
    }
    .inventory-card input[type=number] {
        font-size: 1.2rem;
        font-weight: bold;
        text-align: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-3">
        <div class="col">
            <h3>Kiểm Kê Hàng Hóa Cuối Ca</h3>
            <p class="text-muted">Trước khi kết thúc ca, hãy kiểm tra số lượng thực tế và cập nhật vào các ô bên dưới. Báo cáo sẽ được gửi cho quản lý để đối chiếu.</p>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-md-8">
            <div class="input-group">
                <span class="input-group-text"><i class="bi bi-search"></i></span>
                <input type="text" id="inventory-search" class="form-control" placeholder="Tìm kiếm hàng hóa...">
            </div>
        </div>
        <div class="col-md-4 d-flex align-items-center">
            <div class="progress w-100" style="height: 25px;">
                <div id="inventory-progress-bar" class="progress-bar" role="progressbar" style="width: 0%;"></div>
            </div>
            <strong id="inventory-progress-text" class="ms-2">0/0</strong>
        </div>
    </div>

    <div class="inventory-grid" id="inventory-grid">
        <div class="text-center p-5 col-12">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
            <p class="mt-3">Đang tải dữ liệu kho...</p>
        </div>
    </div>

    <div class="text-center mt-4">
        <!-- <<< SỬA LỖI TẠI ĐÂY: THÊM LẠI SPINNER VÀO BÊN TRONG NÚT >>> -->
        <button class="btn btn-primary btn-lg" id="submit-inventory-btn" disabled>
            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
            <i class="bi bi-send-check-fill me-2"></i>
            <span class="btn-text">Gửi Báo Cáo</span>
        </button>
    </div>
</div>
{% endblock %}


{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- KHAI BÁO BIẾN ---
    const inventoryGrid = document.getElementById('inventory-grid');
    const searchInput = document.getElementById('inventory-search');
    const progressBar = document.getElementById('inventory-progress-bar');
    const progressText = document.getElementById('inventory-progress-text');
    const submitBtn = document.getElementById('submit-inventory-btn');
    
    const API_BASE_URL = '/pos/api';
    let inventoryData = [];

    // --- CÁC HÀM TIỆN ÍCH & API ---
    function getCookie(name) { let cV = null; if (document.cookie && document.cookie !== '') { const c = document.cookie.split(';'); for (let i = 0; i < c.length; i++) { const cK = c[i].trim(); if (cK.substring(0, name.length + 1) === (name + '=')) { cV = decodeURIComponent(cK.substring(name.length + 1)); break; } } } return cV; }
    const postData = async (relativeUrl, data) => {
        const response = await fetch(`${API_BASE_URL}${relativeUrl}`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') }, body: JSON.stringify(data) });
        const result = await response.json();
        if (!response.ok) throw new Error(result.error || 'Lỗi không xác định.');
        return result;
    };

    // --- CÁC HÀM RENDER & UI ---
    function renderInventory(data) {
        inventoryGrid.innerHTML = '';
        if (!data || data.length === 0) {
            inventoryGrid.innerHTML = '<p class="text-muted text-center col-12">Không tìm thấy hàng hóa nào.</p>';
            updateProgress();
            return;
        }

        data.forEach(item => {
            const card = document.createElement('div');
            card.className = 'card inventory-card';
            card.dataset.id = item.id;
            card.dataset.name = item.ten_nguyen_lieu.toLowerCase();

            card.innerHTML = `
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <h5 class="card-title mb-1">${item.ten_nguyen_lieu}</h5>
                            <p class="card-text text-muted mb-2">Đơn vị tính: ${item.don_vi_tinh}</p>
                            <div class="form-check">
                                <input class="form-check-input check-inventory" type="checkbox" value="" id="check-${item.id}">
                                <label class="form-check-label" for="check-${item.id}">Đã kiểm tra</label>
                            </div>
                        </div>
                        <div class="col-auto" style="max-width: 120px;">
                            <label class="form-label text-center d-block small">Số lượng</label>
                            <input type="number" class="form-control physical-count" min="0" step="any" value="${item.so_luong_ton}">
                        </div>
                    </div>
                </div>
            `;
            inventoryGrid.appendChild(card);
        });
        updateProgress();
    }

    function updateProgress() {
        const totalItems = inventoryGrid.querySelectorAll('.inventory-card').length;
        const checkedItems = inventoryGrid.querySelectorAll('.inventory-card.checked-item').length;
        
        progressText.textContent = `${checkedItems}/${totalItems}`;
        const percentage = totalItems > 0 ? (checkedItems / totalItems) * 100 : 0;
        progressBar.style.width = `${percentage}%`;
        progressBar.textContent = `${Math.round(percentage)}%`;

        submitBtn.disabled = (checkedItems !== totalItems || totalItems === 0);
    }
    
    // --- CÁC HÀM LOGIC ---
    async function loadInventoryData() {
        try {
            const response = await fetch(`${API_BASE_URL}/kho/nguyen-lieu/`);
            if (!response.ok) throw new Error('Lỗi tải dữ liệu kho.');
            inventoryData = await response.json();
            renderInventory(inventoryData);
        } catch (error) {
            inventoryGrid.innerHTML = `<div class="alert alert-danger col-12">${error.message}</div>`;
        }
    }

    // --- GẮN SỰ KIỆN ---
    searchInput.addEventListener('input', () => {
        const searchTerm = searchInput.value.toLowerCase();
        inventoryGrid.querySelectorAll('.inventory-card').forEach(card => {
            const itemName = card.dataset.name;
            card.style.display = itemName.includes(searchTerm) ? '' : 'none';
        });
    });

    inventoryGrid.addEventListener('change', e => {
        if (e.target.classList.contains('check-inventory')) {
            const card = e.target.closest('.inventory-card');
            card.classList.toggle('checked-item', e.target.checked);
            updateProgress();
        }
    });

    submitBtn.addEventListener('click', async () => {
        if (!confirm('Bạn có chắc muốn gửi báo cáo kiểm kê? Hành động này không thể hoàn tác.')) return;
        
        const items = [];
        inventoryGrid.querySelectorAll('.inventory-card.checked-item').forEach(card => {
            items.push({
                nguyen_lieu_id: parseInt(card.dataset.id),
                ton_thuc_te: parseFloat(card.querySelector('.physical-count').value) || 0
            });
        });

        if (items.length === 0) {
            alert("Bạn chưa kiểm kê hàng hóa nào.");
            return;
        }
        
        const spinner = submitBtn.querySelector('.spinner-border');
        const btnText = submitBtn.querySelector('.btn-text');
        submitBtn.disabled = true;
        spinner.classList.remove('d-none');
        btnText.textContent = 'Đang gửi...';

        try {
            const result = await postData('/kho/kiem-ke/', { items });
            alert(result.success);
            // Vô hiệu hóa toàn bộ sau khi gửi thành công
            searchInput.disabled = true;
            inventoryGrid.querySelectorAll('input').forEach(input => input.disabled = true);
            submitBtn.innerHTML = '<i class="bi bi-check-circle-fill me-2"></i>Đã Gửi Báo Cáo';
            submitBtn.classList.remove('btn-primary');
            submitBtn.classList.add('btn-success');
        } catch(error) {
            alert(`Lỗi: ${error.message}`);
            submitBtn.disabled = false;
            btnText.textContent = 'Gửi Báo Cáo';
        } finally {
            spinner.classList.add('d-none');
        }
    });

    // --- KHỞI CHẠY ---
    loadInventoryData();
});
</script>
{% endblock %}