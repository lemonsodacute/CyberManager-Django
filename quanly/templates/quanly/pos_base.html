<!-- quanly/templates/quanly/pos_base.html (FINAL FIX) -->
{% load static %}
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Quản Net Pro{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    :root { --sidebar-width: 260px; }
    
    /* <<< PHẦN SỬA ĐỔI CHO ẢNH NỀN (Body) >>> */
    body { 
        background-color: #f0f2f5; 
        
        /* Đặt ảnh nền */
        background-image: url("{% static 'images/GAMING.jpg' %}");
        background-size: cover;
        background-attachment: fixed;
        background-position: center;
        
    } 
    /* <<< PHẦN FIX MÀU TEXT MỚI >>> */
    /* Ép tất cả các tiêu đề và đoạn văn cơ bản có màu sáng */
    h3, h4, p, label, .form-label, .text-muted {
        color: white !important;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7); /* Thêm viền đen nhẹ để dễ đọc hơn */
    }
      /* Đảm bảo các thẻ bài (Cards) giữ nguyên màu đen/xám */
    .card h3, .card h4, .card p, .card h5 {
        color: inherit !important; /* Trả lại màu mặc định của Bootstrap */
        text-shadow: none !important;
    }
    
  /* FIX đặc biệt cho các thẻ trong Card */
    .card .text-muted {
        color: #6c757d !important; /* Màu xám mặc định của Bootstrap */
    }
    /* <<< KẾT THÚC PHẦN FIX MÀU TEXT MỚI >>> */

    /* 2. Đảm bảo nội dung chính có nền trắng/màu mờ (Giữ nguyên) */
    .top-bar, .main-content .card {
         background-color: rgba(255, 255, 255, 0.9); /* Cho nền trong suốt hơn */
    }
    /* Lớp phủ để làm nền tối/mờ không ảnh hưởng đến nội dung chính */
    .content-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1; /* Đảm bảo nó nằm dưới nội dung */
    }
    /* <<< KẾT THÚC PHẦN SỬA ĐỔI CHO ẢNH NỀN >>> */

    .sidebar { width: var(--sidebar-width); background-color: #2c3e50; color: white; flex-shrink: 0; height: 100vh; position: fixed; top: 0; left: 0; }
    .sidebar .nav-link { color: #bdc3c7; border-radius: .3rem; margin: 0.2rem 0; transition: all 0.2s; padding: 0.75rem 1rem; }
    .sidebar .nav-link:hover, .sidebar .nav-link.active { color: white; background-color: #34495e; }
    .sidebar .nav-link .bi { margin-right: 10px; }
    .main-content { margin-left: var(--sidebar-width); width: calc(100% - var(--sidebar-width)); }
    .top-bar { background-color: white; padding: 0.75rem 1.5rem; border-bottom: 1px solid #dee2e6; display: flex; justify-content: space-between; align-items: center; height: 60px; }
    .content-wrapper { padding: 1.5rem; }
</style>
    {% block extra_css %}{% endblock %}
</head>
<body>
    
    <!-- FORM LOGOUT ẨN (FIX LỖI METHOD NOT ALLOWED) -->
    <form id="logout-form" action="{% url 'logout' %}" method="post" style="display: none;">
        {% csrf_token %}
    </form>

    <div class="sidebar d-flex flex-column p-3">
        <a href="{% url 'pos-view' %}" class="d-flex align-items-center mb-3 text-white text-decoration-none">
            <i class="bi bi-display fs-4 me-2"></i>
            <span class="fs-4 fw-bold">Quản Net Pro</span>
        </a>
        <hr>
        <ul class="nav nav-pills flex-column mb-auto">
            <li class="nav-item">
                <a href="{% url 'pos-view' %}" class="nav-link {% if request.resolver_match.url_name == 'pos-view' %}active{% endif %}">
                    <i class="bi bi-grid-1x2-fill"></i> Tổng Quan Máy
                </a>
            </li>
            <li>
                <a href="{% url 'retail-order-view' %}" class="nav-link {% if request.resolver_match.url_name == 'retail-order-view' %}active{% endif %}">
                    <i class="bi bi-cart-plus-fill"></i> POS Bán Lẻ
                </a>
            </li>
         <li>
        <a href="{% url 'customer-management-view' %}" class="nav-link {% if request.resolver_match.url_name == 'customer-management-view' %}active{% endif %}">
            <i class="bi bi-cash-stack"></i> Nạp Tiền Khách Hàng
        </a>
    </li>
             <li>
        <a href="{% url 'inventory-view' %}" class="nav-link {% if request.resolver_match.url_name == 'inventory-view' %}active{% endif %}">
            <i class="bi bi-box-seam-fill"></i> Quản Lý Kho
        </a>
    </li>
             <li>
        <a href="{% url 'reports-view' %}" class="nav-link {% if request.resolver_match.url_name == 'reports-view' %}active{% endif %}">
            <i class="bi bi-clock-history"></i> Báo Cáo / Lịch Sử Ca
        </a>
    </li>
        </ul>
        <hr>
        <div class="dropdown">
             <a href="#" class="d-flex align-items-center text-white text-decoration-none dropdown-toggle" id="dropdownUser1" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-person-circle fs-4 me-2"></i>
                <strong>{% if user.is_authenticated %}{{ user.username }}{% else %}Guest{% endif %}</strong>
            </a>
            <ul class="dropdown-menu dropdown-menu-dark text-small shadow" aria-labelledby="dropdownUser1">
                <!-- Thêm nút Dashboard cho Admin/Staff (Điều kiện có thể được thêm vào đây) -->
                {% if user.is_staff %}
                    <li><a class="dropdown-item" href="{% url 'dashboard_home' %}">Về Dashboard</a></li>
                    <li><a class="dropdown-item" href="{% url 'admin:index' %}">Django Admin</a></li>
                    <li><hr class="dropdown-divider"></li>
                {% endif %}
                <!-- NÚT ĐĂNG XUẤT THỰC TẾ (Sử dụng onclick để kích hoạt form POST) -->
                <li><a class="dropdown-item" href="#" onclick="document.getElementById('logout-form').submit();">Đăng xuất</a></li>
            </ul>
        </div>
    </div>

    <main class="main-content">
    <div class="top-bar" id="top-bar-sticky">
        <div id="ca-lam-viec-info" class="fw-bold">
            <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
            <span class="ms-2">Đang tải thông tin ca...</span>
        </div>
        <div>
             <!-- NÚT NỢ DỊCH VỤ -->
            <button class="btn btn-warning me-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#debtOffcanvas" aria-controls="debtOffcanvas" id="debt-count-btn">
                <i class="bi bi-wallet-fill me-1"></i> Nợ Dịch Vụ 
                <span class="badge bg-danger rounded-pill" id="debt-count">0</span>
            </button>
             <!-- KẾT THÚC NÚT -->

            <button class="btn btn-danger d-none" id="ket-thuc-ca-btn"><i class="bi bi-door-closed-fill me-2"></i>Kết Thúc Ca</button>
        </div>
    </div>
    <div class="content-wrapper">
        {% block content %}{% endblock %}
    </div>
</main>


    <!-- Modal Bắt đầu Ca (Đã có sẵn) -->
    <div class="modal fade" id="startShiftModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="startShiftForm">
                    <div class="modal-header"><h5 class="modal-title"><i class="bi bi-box-arrow-in-right me-2"></i> Bắt Đầu Ca Làm Việc Mới</h5></div>
                    <div class="modal-body">
                        <p>Vui lòng chọn ca và nhập số tiền mặt ban đầu để bắt đầu.</p>
                        <div class="mb-3">
                            <label for="loai_ca_id" class="form-label">Chọn ca của bạn</label>
                            <select class="form-select" id="loai_ca_id" required><option value="">Đang tải...</option></select>
                        </div>
                        <div class="mb-3">
                            <label for="tien_mat_ban_dau" class="form-label">Tiền mặt ban đầu</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="tien_mat_ban_dau" value="0" min="0" required><span class="input-group-text">VNĐ</span>
                            </div>
                        </div>
                        <div id="start-shift-error" class="alert alert-danger d-none"></div>
                    </div>
                    <div class="modal-footer"><button type="submit" class="btn btn-primary w-100">Bắt Đầu Ca</button></div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Modal Nạp Tiền (PHẢI ĐƯỢC INCLUDE Ở ĐÂU ĐÓ) -->
    <!-- Modal Mở Máy Cho Thành Viên (Giữ nguyên) -->
    <div class="modal fade" id="openForMemberModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Mở Máy Cho Thành Viên</h5></div>
                <div class="modal-body">
                    <input type="hidden" id="open-member-machine-id">
                    <p>Tìm và chọn khách hàng để mở máy <strong id="open-member-machine-name" class="text-primary"></strong>.</p>
                    <input type="text" id="member-search-input" class="form-control" placeholder="Nhập tên đăng nhập để tìm...">
                    <div id="member-search-results" class="list-group mt-2" style="max-height: 200px; overflow-y: auto;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- <<< OFFCANVAS NỢ DỊCH VỤ >>> -->
     <div class="offcanvas offcanvas-end" tabindex="-1" id="debtOffcanvas" style="width: 450px;">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title fw-bold">Danh Sách Nợ Dịch Vụ</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body" id="debt-list-container">
            <!-- ĐÃ THÊM HEADER TỔNG CỘNG -->
            <div class="d-flex justify-content-between mb-3 p-2 bg-light rounded shadow-sm">
                <span class="fs-5 fw-bold">TỔNG TIỀN NỢ:</span>
                <span class="fs-5 fw-bold text-danger" id="total-debt-amount">0 VNĐ</span>
            </div>
            <div id="debt-orders-list">
                <div class="text-center p-5"><div class="spinner-border"></div></div>
            </div>
        </div>
    </div>
 
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- KHAI BÁO BIẾN CHUNG ---
        const caLamViecInfo = document.getElementById('ca-lam-viec-info');
        const ketThucCaBtn = document.getElementById('ket-thuc-ca-btn');
        const startShiftModalEl = document.getElementById('startShiftModal');
        // KHỞI TẠO MODAL VỚI KIỂM TRA AN TOÀN ĐỂ TRÁNH LỖI UNDEFINED
        const startShiftModal = startShiftModalEl ? new bootstrap.Modal(startShiftModalEl) : null;
        const startShiftForm = document.getElementById('startShiftForm');
        const API_BASE_URL = '/pos/api';
        
        // SELECTOR NỢ DỊCH VỤ
        const debtCountBadge = document.getElementById('debt-count');
        const debtListContainer = document.getElementById('debt-list-container');
        const debtCountBtn = document.getElementById('debt-count-btn'); 
        const totalDebtAmountEl = document.getElementById('total-debt-amount');

        // --- CÁC HÀM TIỆN ÍCH CHUNG ---
        function getCookie(name) { let cV = null; if (document.cookie && document.cookie !== '') { const c = document.cookie.split(';'); for (let i = 0; i < c.length; i++) { const cK = c[i].trim(); if (cK.substring(0, name.length + 1) === (name + '=')) { cV = decodeURIComponent(cK.substring(name.length + 1)); break; } } } return cV; }
        const csrftoken = getCookie('csrftoken');
        const formatCurrency = (v) => Math.ceil(v || 0).toLocaleString('vi-VN', { style: 'currency', currency: 'VND' }).replace(' VNĐ', ' VNĐ'); // Đảm bảo định dạng tiền tệ
        
        // CÁC HÀM API CHUNG
        const fetchData = async (relativeUrl) => {
            const response = await fetch(`${API_BASE_URL}${relativeUrl}`);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            return await response.json();
        };
        const postData = async (relativeUrl, data) => {
            return apiClient(`${API_BASE_URL}${relativeUrl}`, {
                method: 'POST',
                body: JSON.stringify(data)
            });
        };

        // --- LOGIC XỬ LÝ CA LÀM VIỆC ---
        async function loadDebtList(renderToContainer = true) {
            // Chỉ hiển thị spinner khi offcanvas đang mở
            if (!document.getElementById('debtOffcanvas').classList.contains('show') && renderToContainer) {
                try {
                    const debtOrders = await fetchData('/order/debt-list/');
                    debtCountBadge.textContent = debtOrders.length;
                } catch (error) {
                    debtCountBadge.textContent = '0';
                }
                return;
            }
            
            if (renderToContainer || document.getElementById('debtOffcanvas').classList.contains('show')) {
                 document.getElementById('debt-orders-list').innerHTML = '<div class="text-center p-5"><div class="spinner-border"></div></div>';
            }

            try {
                const debtOrders = await fetchData('/order/debt-list/');
                debtCountBadge.textContent = debtOrders.length;
                
                let totalDebt = 0;
                let listHtml = '';
                
                if (debtOrders.length === 0) {
                    listHtml = '<div class="alert alert-info">Không có Order nào đang nợ.</div>';
                    totalDebtAmountEl.textContent = formatCurrency(0);
                    
                } else {
                    debtOrders.forEach(order => {
                        let detailsHtml = '';
                        order.chi_tiet.forEach(detail => {
                            detailsHtml += `<li>${detail.mon.ten_mon} x ${detail.so_luong}</li>`;
                        });
                        
                        const machineInfo = order.ten_may ? ` - Máy ${order.ten_may}` : '';
                        const hinhThucDisplay = order.phien_su_dung 
                                                ? (order.phien_su_dung.hinh_thuc === 'TRA_TRUOC' ? 'Thành Viên' : 'Vãng Lai') 
                                                : 'Bán Lẻ';
                        
                        const orderDebt = parseFloat(order.tong_tien) || 0;
                        totalDebt += orderDebt;

                        listHtml += `
                            <div class="card mb-3 shadow-sm border-warning">
                                <div class="card-body">
                                    <h5 class="card-title mb-1">Order #${order.id}${machineInfo} (${order.loai_don_hang === 'BAN_LE' ? 'Bán Lẻ' : 'Ghi Nợ'})</h5>
                                    <p class="card-text mb-1 small">
                                        Hình thức: <span class="fw-bold">${hinhThucDisplay}</span>
                                        | Mã KM: <span class="fw-bold">${order.ma_khuyen_mai_ap_dung || 'Không'}</span>
                                    </p>
                                    <p class="card-text fs-5 fw-bold text-danger">
                                        Tổng nợ: ${formatCurrency(orderDebt)}
                                    </p>
                                    <h6 class="mt-2 small">Chi tiết:</h6>
                                    <ul class="list-unstyled small ps-3">${detailsHtml}</ul>
                                    <button class="btn btn-sm btn-success w-100 pay-debt-btn" data-id="${order.id}">
                                        <i class="bi bi-check-circle-fill me-1"></i> Xác Nhận Đã Thu Tiền
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                }
                
                if (renderToContainer || document.getElementById('debtOffcanvas').classList.contains('show')) {
                    document.getElementById('debt-orders-list').innerHTML = listHtml;
                }
                totalDebtAmountEl.textContent = formatCurrency(totalDebt);

            } catch (error) {
                if (renderToContainer || document.getElementById('debtOffcanvas').classList.contains('show')) {
                    document.getElementById('debt-orders-list').innerHTML = `<div class="alert alert-danger">Lỗi tải danh sách nợ: ${error.message}</div>`;
                }
                debtCountBadge.textContent = '0';
                totalDebtAmountEl.textContent = formatCurrency(0);
            }
        }
        
        async function openStartShiftModal() {
            const selectEl = document.getElementById('loai_ca_id');
            selectEl.innerHTML = '<option value="">Đang tải...</option>';
            try {
                const shiftTypes = await fetchData('/loai-ca/');
                selectEl.innerHTML = '<option value="" disabled selected>-- Chọn ca làm việc --</option>';
                shiftTypes.forEach(type => {
                    selectEl.innerHTML += `<option value="${type.id}">${type.ten_ca} (${type.gio_bat_dau} - ${type.gio_ket_thuc})</option>`;
                });
                if (startShiftModal) startShiftModal.show();
            } catch (error) {
                const errorDiv = document.getElementById('start-shift-error');
                errorDiv.textContent = 'Không thể tải danh sách ca. Vui lòng kiểm tra kết nối.';
                errorDiv.classList.remove('d-none');
            }
        }
        
        async function updateCaInfo() {
            try {
                const currentShift = await fetchData('/ca/hien-tai/');
                if (startShiftModal && startShiftModalEl.classList.contains('show')) startShiftModal.hide();
                
                const startTime = new Date(currentShift.thoi_gian_bat_dau_thuc_te);
                
                caLamViecInfo.innerHTML = `
                    <i class="bi bi-clock-fill text-success"></i> 
                    <strong>Ca:</strong> <span class="text-primary">${currentShift.loai_ca.ten_ca}</span> | 
                    <strong>NV:</strong> ${currentShift.nhan_vien.tai_khoan} | 
                    <strong>Bắt đầu:</strong> ${startTime.toLocaleTimeString('vi-VN')} |
                    <strong>Tổng thu:</strong> <span class="text-danger fw-bold">${formatCurrency(currentShift.tong_thu_hien_tai)}</span>
                `;
                ketThucCaBtn.classList.remove('d-none');
                debtCountBtn.disabled = false;
                
                loadDebtList(false); // Cập nhật badge Nợ
                
            } catch (error) {
                caLamViecInfo.innerHTML = `
                    <div class="alert alert-warning py-1 px-3 mb-0 d-flex align-items-center">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        <strong>Chưa bắt đầu ca làm việc!</strong>
                        <button class="btn btn-primary btn-sm ms-3" id="manual-start-shift-btn">Bắt Đầu Ca</button>
                    </div>
                `;
                ketThucCaBtn.classList.add('d-none');
                debtCountBtn.disabled = true;
                document.getElementById('manual-start-shift-btn')?.addEventListener('click', openStartShiftModal);
                
                if (!startShiftModalEl.classList.contains('show')) {
                    openStartShiftModal();
                }
            }
        }

        async function payDebt(orderId) {
            const orderCard = document.querySelector(`.pay-debt-btn[data-id="${orderId}"]`).closest('.card');
            const totalText = orderCard.querySelector('.fs-5').textContent;

            if (!confirm(`Xác nhận đã thu tiền Order #${orderId} (${totalText})? Hành động này không thể hoàn tác.`)) return;

            const btn = orderCard.querySelector('.pay-debt-btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Đang xử lý...';
            
            try {
                const result = await postData(`/order/${orderId}/pay-debt/`, {});
                alert(result.success);
                await loadDebtList(true); // Tải lại danh sách và render
                updateCaInfo(); // Cập nhật tổng thu trên top bar
            } catch(error) {
                alert(`Lỗi khi xác nhận thanh toán: ${error.message}`);
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-check-circle-fill me-1"></i> Xác Nhận Đã Thu Tiền';
            }
        }
        
        // SỰ KIỆN CHO OFFCANVAS
        document.getElementById('debtOffcanvas').addEventListener('shown.bs.offcanvas', () => loadDebtList(true)); 
        
        debtListContainer.addEventListener('click', (e) => {
            const btn = e.target.closest('.pay-debt-btn');
            if (btn) payDebt(btn.dataset.id);
        });
        
        // Tải danh sách nợ dịch vụ mỗi 60s để cập nhật badge
        setInterval(() => loadDebtList(false), 60000);

        // --- KHỞI CHẠY CHUNG ---
        updateCaInfo();
        setInterval(updateCaInfo, 30000);
    });
</script>
<!-- ✅ Chỉ giữ MỘT bản api_client.js -->
<script src="http://127.0.0.1:9000{% static 'js/api_client.js' %}"></script>

<!-- ✅ Bootstrap Bundle (có cả Popper + Modal) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    {% block extra_js %}{% endblock %}
</body>
</html>