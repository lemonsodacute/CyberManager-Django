{% load static %}
<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% block title %}Qu·∫£n Net Pro{% endblock %}</title>

  <!-- Bootstrap + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <!-- ===== NEON THEME (frontend only; kh√¥ng ƒë·ªïi backend) ===== -->
  <style>
    :root{
      --bg:#050813;--nav:#060b18;--panel:#0e1326;--panel-2:#0b1022;
      --muted:#1a1f3b;--text:#e5e7eb;--muted-text:#9ca3af;
      --violet:#a855f7;--violet-2:#d946ef;--cyan:#22d3ee;
    }
    html{scroll-behavior:smooth}
    body{background:var(--bg);color:var(--text)}
    ::selection{background:var(--violet-2);color:#fff}

    /* ·∫®n sidebar g·ªëc nh∆∞ng KH√îNG x√≥a ‚Äì ƒë·ªÉ backend kh√°c c√≤n d√πng */
    .sidebar{display:none}
    .main-content{margin-left:0;width:100%;min-height:100vh}

    /* ===== Header gi·ªëng ·∫£nh ===== */
    .top-bar{
      background:var(--nav)!important;
      border-bottom:1px solid rgba(162,69,255,.25);
      padding:18px 22px!important;
      position:sticky;top:0;z-index:999;
    }
    /* stack hai n√∫t theo chi·ªÅu d·ªçc */
.top-bar-actions{
  display:flex;
  flex-direction: column;   /* <‚Äî CH√çNH: x·∫øp d·ªçc */
  gap: .5rem;
  align-items: stretch;     /* cho n√∫t ƒë·ªÅu nhau, full theo container */
}
.top-bar-actions .btn{ width: 220px; } /* tu·ª≥ ch·ªânh: ngang b·∫±ng ƒë·∫πp m·∫Øt */

    .brand-row{display:flex;align-items:center;justify-content:space-between}
    .brand-left{display:flex;align-items:center;gap:14px}
    .brand-badge{font-size:36px;line-height:1;filter:drop-shadow(0 0 8px rgba(217,70,239,.55))}
    .brand-title{
      margin:0;font-weight:800;letter-spacing:.5px;color:#f0e1ff;font-size:28px;
      text-shadow:0 0 6px rgba(217,70,239,.7),0 0 14px rgba(168,85,247,.55)
    }
    .brand-sub{margin:2px 0 0;color:#7de9ff;font-size:14px;text-shadow:0 0 8px rgba(34,211,238,.55)}

    /* N√∫t k·∫øt th√∫c ca ‚Äì GI·ªÆ id ƒë·ªÉ JS ho·∫°t ƒë·ªông */
    #ket-thuc-ca-btn{
      display:inline-flex !important;background:linear-gradient(90deg,#c026d3,#a855f7);
      border:none;color:#fff;font-weight:700;padding:.55rem 1.05rem;border-radius:.9rem;
      box-shadow:0 0 16px rgba(168,85,247,.6)
    }
    #ket-thuc-ca-btn:hover{filter:brightness(1.05);box-shadow:0 0 26px rgba(168,85,247,.85);transform:translateY(-1px)}

    /* Thanh nav ngang gi·ªëng ·∫£nh */
    .neon-nav{background:var(--nav);border-bottom:1px solid rgba(162,69,255,.25);padding:0 22px}
    .neon-nav .nav{gap:28px;overflow-x:auto;white-space:nowrap}
    .neon-nav .nav-link{color:#cfd8ff;opacity:.85;border:none;border-bottom:2px solid transparent;padding:14px 0;font-weight:700;display:flex;align-items:center;gap:10px}
    .neon-nav .nav-link:hover{opacity:1;color:#f0e1ff}
    .neon-nav .nav-link.active{color:#f0e1ff;opacity:1;border-color:#7b2cbf;text-shadow:0 0 8px rgba(168,85,247,.7)}

    /* N·ªôi dung */
    .content-wrapper{padding:1.5rem;max-width:1600px;margin:0 auto}
    .card{background:var(--panel);border:1px solid var(--muted);color:var(--text);border-radius:.75rem}
    .card-header{background:var(--panel-2);border-color:var(--muted)}
    .list-group-item{background:var(--panel-2);border-color:var(--muted);color:#cbd5e1}
    .modal-content,.offcanvas{background:var(--panel-2);color:var(--text)}
    .input-group-text{background:#0b1220;color:var(--muted-text);border-color:var(--muted)}
    .form-control,.form-select{background:#0b1220;color:var(--text);border-color:var(--muted)}
    .form-control:focus,.form-select:focus{border-color:var(--violet);box-shadow:0 0 0 3px rgba(168,85,247,.25)}
    .btn-warning{background:#f59e0b;border:none}
    .badge.bg-danger{background:#ef4444!important}
    .spinner-border{width:1.1rem;height:1.1rem;border-width:2px}
  /* === Action buttons: x·∫øp d·ªçc, NG·∫ÆN l·∫°i, cƒÉn gi·ªØa === */
:root{
  --action-btn-w: 210px;   /* ‚Üê ch·ªânh t·∫°i ƒë√¢y n·∫øu mu·ªën ng·∫Øn/d√†i h∆°n */
}

.top-bar-actions{
  display: flex;
  flex-direction: column;   /* x·∫øp d·ªçc */
  gap: .6rem;
  align-items: center;      /* cƒÉn gi·ªØa theo c·ªôt */
}

/* √°p d·ª•ng c√πng k√≠ch th∆∞·ªõc cho 2 n√∫t */
.top-bar-actions .btn{
  width: var(--action-btn-w);
  max-width: 100%;
  justify-content: center;  /* cƒÉn gi·ªØa icon + text trong n√∫t */
  padding: .55rem .9rem;    /* g·ªçn n√∫t h∆°n */
  border-radius: .8rem;
}

/* n√∫t K·∫øt Th√∫c Ca ‚Äì v·∫´n gi·ªØ gradient n·∫øu b·∫°n ƒë√£ c√≥ */
#ket-thuc-ca-btn{
  display: inline-flex !important;
  justify-content: center;   /* cƒÉn gi·ªØa n·ªôi dung n√∫t */
  text-align: center;
}

/* (t√πy ch·ªçn) icon c√°ch ch·ªØ 1 ch√∫t cho c√¢n */
.top-bar-actions .btn .bi{ margin-right: .45rem; }
/* ƒëo chi·ªÅu cao b·∫±ng bi·∫øn (JS s·∫Ω c·∫≠p nh·∫≠t) */
:root { --topbar-h: 86px; --nav-h: 54px; }

/* HEADER c·ªë ƒë·ªãnh */
.top-bar{
  position: fixed !important;
  top: 0; left: 0; right: 0;
  z-index: 1100;
}

/* NAV ‚ÄúT·ªïng Quan M√°y ¬∑ POS B√°n L·∫ª ‚Ä¶‚Äù c·ªë ƒë·ªãnh */
nav.neon-nav{
  position: fixed !important;
  top: var(--topbar-h);
  left: 0; right: 0;
  z-index: 1099;
  width: 100%;
}

/* ƒê·∫©y ph·∫ßn n·ªôi dung xu·ªëng, tr√°nh b·ªã che */
.main-content{
  margin-top: calc(var(--topbar-h) + var(--nav-h)) !important;
}

/* T·∫Øt hi·ªáu ·ª©ng ‚Äúnh√≠ch‚Äù khi hover ƒë·ªÉ nh√¨n nh∆∞ ƒë·ª©ng y√™n tuy·ªát ƒë·ªëi */
.neon-nav .nav-link{ transform:none !important; }
.neon-nav .nav-link:hover{ transform:none !important; }

/* ==== FIX: Offcanvas (N·ª£ D·ªãch V·ª•) kh√¥ng b·ªã che ==== */
.offcanvas {
  z-index: 2000 !important;         /* ƒë·∫£m b·∫£o cao h∆°n topbar (1100) v√† nav (1099) */
  margin-top: calc(var(--topbar-h) + var(--nav-h));  /* ƒë·∫©y xu·ªëng d∆∞·ªõi header v√† nav */
  height: calc(100vh - (var(--topbar-h) + var(--nav-h)));  /* v·ª´a kh√≠t ph·∫ßn c√≤n l·∫°i */
  border-top-left-radius: 1rem;
  border-bottom-left-radius: 1rem;
  overflow-y: auto;                 /* cu·ªôn n·∫øu n·ªôi dung d√†i */
  background: var(--panel-2);
  box-shadow: -4px 0 20px rgba(0, 0, 0, 0.5);
}
.offcanvas-header {
  position: sticky;
  top: 0;
  z-index: 2001;
  background: var(--panel);
  border-bottom: 1px solid var(--muted);
}

</style>

<style>
  @import url('/static/css/offcanvas_fix.css');
</style>

  {% block extra_css %}{% endblock %}
</head>
<body>

  <!-- gi·ªØ nguy√™n ƒë·ªÉ logout -->
  <form id="logout-form" action="{% url 'logout' %}" method="post" style="display:none;">{% csrf_token %}</form>

  <!-- ===== HEADER ===== -->
  <div class="top-bar">
    <div class="brand-row">
      <div class="brand-left">
        <div class="brand-badge">‚öîÔ∏è</div>
        <div>
          <h1 class="brand-title">QU√ÅN NET PRO</h1>
          <div class="brand-sub">Gaming Arena Management System</div>
        </div>
      </div>

      <!-- v·ªã tr√≠ backend s·∫Ω thay n·ªôi dung -->
      <div id="ca-lam-viec-info" class="mx-3">
        <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
        <span class="ms-2">ƒêang t·∫£i th√¥ng tin ca...</span>
      </div>

      <div class="top-bar-actions d-flex align-items-center">
        <button class="btn btn-warning me-2" type="button" data-bs-toggle="offcanvas"
                data-bs-target="#debtOffcanvas" aria-controls="debtOffcanvas" id="debt-count-btn">
          <i class="bi bi-wallet-fill"></i>
          <span>N·ª£ D·ªãch V·ª•</span>
          <span class="badge bg-danger rounded-pill" id="debt-count">0</span>
        </button>
        <button class="btn d-none" id="ket-thuc-ca-btn">
          <i class="bi bi-door-closed-fill me-1"></i>K·∫øt Th√∫c Ca
        </button>
      </div>
    </div>
  </div>

  <!-- ===== NAV ===== -->
  <nav class="neon-nav">
    <ul class="nav py-0 my-0">
      <li class="nav-item">
        <a href="{% url 'pos-view' %}" class="nav-link {% if request.resolver_match.url_name == 'pos-view' %}active{% endif %}">üè† T·ªïng Quan M√°y</a>
      </li>
      <li class="nav-item">
        <a href="{% url 'retail-order-view' %}" class="nav-link {% if request.resolver_match.url_name == 'retail-order-view' %}active{% endif %}">üõí POS B√°n L·∫ª</a>
      </li>
      <li class="nav-item">
        <a href="{% url 'customer-management-view' %}" class="nav-link {% if request.resolver_match.url_name == 'customer-management-view' %}active{% endif %}">üë• Kh√°ch H√†ng</a>
      </li>
      <li class="nav-item">
        <a href="{% url 'reports-view' %}" class="nav-link {% if request.resolver_match.url_name == 'reports-view' %}active{% endif %}">üóìÔ∏è Ca L√†m Vi·ªác</a>
      </li>
      <li class="nav-item">
        <a href="{% url 'inventory-view' %}" class="nav-link {% if request.resolver_match.url_name == 'inventory-view' %}active{% endif %}">üì¶ Ki·ªÉm K√™</a>
      </li>
      <li class="nav-item">
        <a href="{% url 'machine-map-view' %}" class="nav-link {% if request.resolver_match.url_name == 'machine-map-view' %}active{% endif %}">üíª S∆° ƒê·ªì M√°y</a>
      </li>
    </ul>
  </nav>

  <!-- ===== MAIN CONTENT ===== -->
  <main class="main-content">
    <div class="content-wrapper">
      {% block content %}{% endblock %}
    </div>
  </main>

  <!-- ===== MODALS/OFFCANVAS ‚Äì GI·ªÆ backend ===== -->
  <div class="modal fade" id="startShiftModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <form id="startShiftForm">
          <div class="modal-header">
            <h5 class="modal-title"><i class="bi bi-box-arrow-in-right me-2"></i>B·∫Øt ƒê·∫ßu Ca L√†m Vi·ªác M·ªõi</h5>
          </div>
          <div class="modal-body">
            <p class="text-muted mb-4">Vui l√≤ng ch·ªçn ca v√† nh·∫≠p s·ªë ti·ªÅn m·∫∑t ban ƒë·∫ßu ƒë·ªÉ b·∫Øt ƒë·∫ßu.</p>
            <div class="mb-3">
              <label for="loai_ca_id" class="form-label">Ch·ªçn ca c·ªßa b·∫°n</label>
              <select class="form-select" id="loai_ca_id" required>
                <option value="">ƒêang t·∫£i...</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="tien_mat_ban_dau" class="form-label">Ti·ªÅn m·∫∑t ban ƒë·∫ßu</label>
              <div class="input-group">
                <input type="number" class="form-control" id="tien_mat_ban_dau" value="0" min="0" required>
                <span class="input-group-text">VNƒê</span>
              </div>
            </div>
            <div id="start-shift-error" class="alert alert-danger d-none"></div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary w-100">B·∫Øt ƒê·∫ßu Ca</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="modal fade" id="openForMemberModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">M·ªü M√°y Cho Th√†nh Vi√™n</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="open-member-machine-id">
          <p class="text-muted mb-3">T√¨m v√† ch·ªçn kh√°ch h√†ng ƒë·ªÉ m·ªü m√°y <strong id="open-member-machine-name" class="text-primary"></strong>.</p>
          <input type="text" id="member-search-input" class="form-control" placeholder="Nh·∫≠p t√™n ƒëƒÉng nh·∫≠p ƒë·ªÉ t√¨m...">
          <div id="member-search-results" class="list-group mt-3" style="max-height:250px;overflow-y:auto;"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
        </div>
      </div>
    </div>
  </div>

  <div class="offcanvas offcanvas-end" tabindex="-1" id="debtOffcanvas" style="width:480px;">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title"><i class="bi bi-wallet2 me-2"></i>Danh S√°ch N·ª£ D·ªãch V·ª•</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body" id="debt-list-container">
      <div class="card border-0 mb-4">
        <div class="card-body d-flex justify-content-between align-items-center">
          <span class="fw-bold text-secondary">T·ªîNG TI·ªÄN N·ª¢:</span>
          <span class="fs-4 fw-bold text-danger" id="total-debt-amount">0 VNƒê</span>
        </div>
      </div>
      <div id="debt-orders-list">
        <div class="text-center p-5">
          <div class="spinner-border text-primary"></div>
          <p class="text-muted mt-2">ƒêang t·∫£i...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal k·∫øt th√∫c ca -->
    <div class="modal fade" id="endShiftModal" tabindex="-1" aria-labelledby="endShiftModalLabel" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <form id="endShiftForm">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title" id="endShiftModalLabel"><i class="bi bi-door-open-fill me-2"></i> Ch·ªët Ca & K·∫øt Th√∫c</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <h6>Ca: <span id="end-shift-name" class="text-primary"></span></h6>
                        <hr>
                        <div class="cost-section">
                            <div class="cost-row">
                                <span class="info-label">Ti·ªÅn m·∫∑t ban ƒë·∫ßu (H·ªá th·ªëng):</span>
                                <span id="end-shift-cash-start" class="info-value">0 ƒë</span>
                            </div>
                            <div class="cost-row">
                                <span class="info-label">T·ªïng Doanh Thu (H·ªá th·ªëng):</span>
                                <span id="end-shift-revenue" class="info-value">0 ƒë</span>
                            </div>
                            <div class="cost-row">
                                <span class="info-label">T·ªïng ti·ªÅn m·∫∑t c·∫ßn c√≥ (L√Ω thuy·∫øt):</span>
                                <span id="end-shift-theoretical-total" class="info-value">0 ƒë</span>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="end-shift-actual-cash" class="form-label">S·ªë ti·ªÅn m·∫∑t th·ª±c t·∫ø ƒë·∫øm ƒë∆∞·ª£c</label>
                            <div class="input-group">
                                <input type="number" id="end-shift-actual-cash" class="form-control" min="0" step="1000" required>
                                <span class="input-group-text">VNƒê</span>
                            </div>
                        </div>
                        <div id="end-shift-error" class="alert alert-danger d-none mt-2"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-danger w-100"><i class="bi bi-power me-2"></i> CH·ªêT CA & ƒêƒÇNG XU·∫§T</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

  <!-- ===== BACKEND JS gi·ªØ nguy√™n logic ===== -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const caLamViecInfo = document.getElementById('ca-lam-viec-info');
      const ketThucCaBtn = document.getElementById('ket-thuc-ca-btn');
      const startShiftModalEl = document.getElementById('startShiftModal');
      const startShiftModal = startShiftModalEl ? new bootstrap.Modal(startShiftModalEl) : null;
      const startShiftForm = document.getElementById('startShiftForm');
      const API_BASE_URL = '/pos/api';

        const topBar = document.querySelector('.top-bar');
  const neonNav = document.querySelector('nav.neon-nav');
  const main = document.querySelector('.main-content');

      const debtCountBadge = document.getElementById('debt-count');
      const debtListContainer = document.getElementById('debt-list-container');
      const debtCountBtn = document.getElementById('debt-count-btn');
      const totalDebtAmountEl = document.getElementById('total-debt-amount');

        function applyOffsets(){
    const th = topBar ? topBar.offsetHeight : 0;
    const nh = neonNav ? neonNav.offsetHeight : 0;
    document.documentElement.style.setProperty('--topbar-h', th + 'px');
    document.documentElement.style.setProperty('--nav-h', nh + 'px');
    if (main) main.style.marginTop = `calc(${th}px + ${nh}px)`;
  }
  applyOffsets();
  window.addEventListener('resize', applyOffsets);

      function getCookie(name) {
        let cV = null;
        if (document.cookie && document.cookie !== '') {
          const c = document.cookie.split(';');
          for (let i = 0; i < c.length; i++) {
            const cK = c[i].trim();
            if (cK.substring(0, name.length + 1) === (name + '=')) {
              cV = decodeURIComponent(cK.substring(name.length + 1));
              break;
            }
          }
        }
        return cV;
      }
      const csrftoken = getCookie('csrftoken');
      const formatCurrency = (v) => Math.ceil(v || 0).toLocaleString('vi-VN', { style: 'currency', currency: 'VND' }).replace(' VNƒê', ' VNƒê');

      const fetchData = async (relativeUrl) => {
        const response = await fetch(`${API_BASE_URL}${relativeUrl}`);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return await response.json();
      };

      const postData = async (relativeUrl, data) => {
        return apiClient(`${API_BASE_URL}${relativeUrl}`, {
          method: 'POST',
          body: JSON.stringify(data)
        });
      };

      async function loadDebtList(renderToContainer = true) {
        if (!document.getElementById('debtOffcanvas').classList.contains('show') && renderToContainer) {
          try {
            const debtOrders = await fetchData('/order/debt-list/');
            debtCountBadge.textContent = debtOrders.length;
          } catch (error) {
            debtCountBadge.textContent = '0';
          }
          return;
        }

        if (renderToContainer || document.getElementById('debtOffcanvas').classList.contains('show')) {
          document.getElementById('debt-orders-list').innerHTML =
            '<div class="text-center p-5"><div class="spinner-border text-primary"></div><p class="text-muted mt-2">ƒêang t·∫£i...</p></div>';
        }

        try {
          const debtOrders = await fetchData('/order/debt-list/');
          debtCountBadge.textContent = debtOrders.length;

          let totalDebt = 0;
          let listHtml = '';

          if (debtOrders.length === 0) {
            listHtml = '<div class="alert alert-info"><i class="bi bi-info-circle me-2"></i>Kh√¥ng c√≥ Order n√†o ƒëang n·ª£.</div>';
            totalDebtAmountEl.textContent = formatCurrency(0);

          } else {
            debtOrders.forEach(order => {
              let detailsHtml = '';
              order.chi_tiet.forEach(detail => {
                detailsHtml += `<li class="mb-1"><i class="bi bi-dot text-primary"></i>${detail.mon.ten_mon} <span class="badge bg-secondary">x${detail.so_luong}</span></li>`;
              });

              const machineInfo = order.ten_may ? ` - M√°y ${order.ten_may}` : '';
              const hinhThucDisplay = order.phien_su_dung
                                      ? (order.phien_su_dung.hinh_thuc === 'TRA_TRUOC' ? 'Th√†nh Vi√™n' : 'V√£ng Lai')
                                      : 'B√°n L·∫ª';

              const orderDebt = parseFloat(order.tong_tien) || 0;
              totalDebt += orderDebt;

              listHtml += `
                <div class="card mb-3 border-warning">
                  <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                      <h6 class="card-title mb-0 fw-bold">Order #${order.id}${machineInfo}</h6>
                      <span class="badge ${order.loai_don_hang === 'BAN_LE' ? 'bg-info' : 'bg-warning'}">${order.loai_don_hang === 'BAN_LE' ? 'B√°n L·∫ª' : 'Ghi N·ª£'}</span>
                    </div>
                    <div class="mb-2">
                      <small class="text-muted">
                        <i class="bi bi-person me-1"></i>${hinhThucDisplay}
                        <span class="mx-2">|</span>
                        <i class="bi bi-tag me-1"></i>${order.ma_khuyen_mai_ap_dung || 'Kh√¥ng KM'}
                      </small>
                    </div>
                    <div class="mb-3">
                      <span class="fs-5 fw-bold text-danger">${formatCurrency(orderDebt)}</span>
                    </div>
                    <div class="mb-3">
                      <small class="text-muted fw-semibold">Chi ti·∫øt m√≥n:</small>
                      <ul class="list-unstyled ps-2 mt-1 small">${detailsHtml}</ul>
                    </div>
                    <button class="btn btn-success w-100 pay-debt-btn" data-id="${order.id}">
                      <i class="bi bi-check-circle-fill"></i>
                      <span>X√°c Nh·∫≠n ƒê√£ Thu Ti·ªÅn</span>
                    </button>
                  </div>
                </div>
              `;
            });
          }

          if (renderToContainer || document.getElementById('debtOffcanvas').classList.contains('show')) {
            document.getElementById('debt-orders-list').innerHTML = listHtml;
          }
          totalDebtAmountEl.textContent = formatCurrency(totalDebt);

        } catch (error) {
          if (renderToContainer || document.getElementById('debtOffcanvas').classList.contains('show')) {
            document.getElementById('debt-orders-list').innerHTML =
              `<div class="alert alert-danger"><i class="bi bi-exclamation-triangle me-2"></i>L·ªói t·∫£i danh s√°ch n·ª£: ${error.message}</div>`;
          }
          debtCountBadge.textContent = '0';
          totalDebtAmountEl.textContent = formatCurrency(0);
        }
      }

      async function openStartShiftModal() {
        const selectEl = document.getElementById('loai_ca_id');
        selectEl.innerHTML = '<option value="">ƒêang t·∫£i...</option>';
        try {
          const shiftTypes = await fetchData('/loai-ca/');
          selectEl.innerHTML = '<option value="" disabled selected>-- Ch·ªçn ca l√†m vi·ªác --</option>';
          shiftTypes.forEach(type => {
            selectEl.innerHTML += `<option value="${type.id}">${type.ten_ca} (${type.gio_bat_dau} - ${type.gio_ket_thuc})</option>`;
          });
          if (startShiftModal) startShiftModal.show();
        } catch (error) {
          const errorDiv = document.getElementById('start-shift-error');
          errorDiv.innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i>Kh√¥ng th·ªÉ t·∫£i danh s√°ch ca. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi.';
          errorDiv.classList.remove('d-none');
        }
      }

      async function updateCaInfo() {
        try {
          const currentShift = await fetchData('/ca/hien-tai/');
          if (startShiftModal && startShiftModalEl.classList.contains('show')) startShiftModal.hide();

          const startTime = new Date(currentShift.thoi_gian_bat_dau_thuc_te);

caLamViecInfo.innerHTML = `
  <div class="d-flex flex-wrap align-items-center gap-4">
    <div class="d-flex align-items-center gap-2">
      <i class="bi bi-clock-fill text-success"></i>
      <span><strong>Ca:</strong> <span class="text-primary">${currentShift.loai_ca.ten_ca}</span></span>
    </div>
    <div class="d-flex align-items-center gap-2">
      <i class="bi bi-person-fill"></i>
      <span><strong>NV:</strong> ${currentShift.nhan_vien.tai_khoan}</span>
    </div>
    <div class="d-flex align-items-center gap-2">
      <i class="bi bi-calendar-check"></i>
      <span><strong>B·∫Øt ƒë·∫ßu:</strong> ${startTime.toLocaleTimeString('vi-VN')}</span>
    </div>
    <div class="d-flex align-items-center gap-2">
      <i class="bi bi-cash-coin"></i>
      <span><strong>T·ªïng thu:</strong> <span class="text-danger fw-bold">${formatCurrency(currentShift.tong_thu_hien_tai)}</span></span>
    </div>
  </div>
`;

          ketThucCaBtn.classList.remove('d-none');
          debtCountBtn.disabled = false;

          // G·∫Øn s·ª± ki·ªán click ƒë·ªÉ m·ªü modal ch·ªët ca
if (ketThucCaBtn && !ketThucCaBtn.dataset.bound) {
  ketThucCaBtn.addEventListener('click', async () => {
    try {
      const currentShift = await fetchData('/ca/hien-tai/');
      // G√°n d·ªØ li·ªáu ca hi·ªán t·∫°i v√†o modal
      document.getElementById('end-shift-name').textContent = currentShift.loai_ca.ten_ca;
      document.getElementById('end-shift-cash-start').textContent = formatCurrency(currentShift.tien_mat_ban_dau);
      document.getElementById('end-shift-revenue').textContent = formatCurrency(currentShift.tong_thu_hien_tai);
      const tongLyThuyet = (currentShift.tien_mat_ban_dau || 0) + (currentShift.tong_thu_hien_tai || 0);
      document.getElementById('end-shift-theoretical-total').textContent = formatCurrency(tongLyThuyet);
      document.getElementById('end-shift-actual-cash').value = tongLyThuyet;
      new bootstrap.Modal(document.getElementById('endShiftModal')).show();
    } catch (err) {
      alert('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu ca hi·ªán t·∫°i. Vui l√≤ng th·ª≠ l·∫°i!');
    }
  });
  ketThucCaBtn.dataset.bound = 'true'; // tr√°nh g·∫Øn nhi·ªÅu l·∫ßn
}

        
          loadDebtList(false);

        } catch (error) {
          caLamViecInfo.innerHTML = `
            <div class="alert alert-warning py-2 px-3 mb-0 d-flex align-items-center gap-3">
              <i class="bi bi-exclamation-triangle-fill fs-5"></i>
              <span class="fw-semibold">Ch∆∞a b·∫Øt ƒë·∫ßu ca l√†m vi·ªác!</span>
              <button class="btn btn-primary btn-sm ms-auto" id="manual-start-shift-btn">
                <i class="bi bi-play-fill"></i>
                <span>B·∫Øt ƒê·∫ßu Ca</span>
              </button>
            </div>
          `;
          ketThucCaBtn.classList.add('d-none');
          debtCountBtn.disabled = true;
          document.getElementById('manual-start-shift-btn')?.addEventListener('click', openStartShiftModal);

          if (!startShiftModalEl.classList.contains('show')) {
            openStartShiftModal();
          }
        }
      }

      // === X·ª¨ L√ù N√öT K·∫æT TH√öC CA ===
const endShiftModalEl = document.getElementById('endShiftModal');
const endShiftModal = endShiftModalEl ? new bootstrap.Modal(endShiftModalEl) : null;
const endShiftForm = document.getElementById('endShiftForm');

if (ketThucCaBtn) {
  ketThucCaBtn.addEventListener('click', async () => {
    try {
      const currentShift = await fetchData('/ca/hien-tai/');
      // ƒê·ªï d·ªØ li·ªáu v√†o modal
      document.getElementById('end-shift-name').textContent = currentShift.loai_ca.ten_ca;
      document.getElementById('end-shift-cash-start').textContent = formatCurrency(currentShift.tien_mat_ban_dau);
      document.getElementById('end-shift-revenue').textContent = formatCurrency(currentShift.tong_thu_hien_tai);
      const theoretical = currentShift.tien_mat_ban_dau + currentShift.tong_thu_hien_tai;
      document.getElementById('end-shift-theoretical-total').textContent = formatCurrency(theoretical);
      document.getElementById('end-shift-actual-cash').value = theoretical;
      if (endShiftModal) endShiftModal.show();
    } catch (err) {
      alert('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu ca hi·ªán t·∫°i. Vui l√≤ng ki·ªÉm tra l·∫°i!');
    }
  });
}

// === G·ª¨I FORM CH·ªêT CA ===
if (endShiftForm) {
  endShiftForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const actualCash = parseFloat(document.getElementById('end-shift-actual-cash').value) || 0;
    try {
      const result = await postData('/ca/ket-thuc/', { tien_mat_thuc_te: actualCash });
      alert('ƒê√£ k·∫øt th√∫c ca th√†nh c√¥ng!');
      window.location.href = '/logout/';
    } catch (error) {
      const errDiv = document.getElementById('end-shift-error');
      errDiv.textContent = `L·ªói khi ch·ªët ca: ${error.message}`;
      errDiv.classList.remove('d-none');
    }
  });
}


      async function payDebt(orderId) {
        const orderCard = document.querySelector(`.pay-debt-btn[data-id="${orderId}"]`).closest('.card');
        const totalText = orderCard.querySelector('.fs-5').textContent;

        if (!confirm(`X√°c nh·∫≠n ƒë√£ thu ti·ªÅn Order #${orderId} (${totalText})?\n\nH√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.`)) return;

        const btn = orderCard.querySelector('.pay-debt-btn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span><span class="ms-2">ƒêang x·ª≠ l√Ω...</span>';

        try {
          const result = await postData(`/order/${orderId}/pay-debt/`, {});
          alert(result.success);
          await loadDebtList(true);
          updateCaInfo();
        } catch(error) {
          alert(`L·ªói khi x√°c nh·∫≠n thanh to√°n: ${error.message}`);
          btn.disabled = false;
          btn.innerHTML = '<i class="bi bi-check-circle-fill"></i><span>X√°c Nh·∫≠n ƒê√£ Thu Ti·ªÅn</span>';
        }
      }

      // submit start shift
      const startShiftFormEl = document.getElementById('startShiftForm');
      if (startShiftFormEl) {
        startShiftFormEl.addEventListener('submit', async (e) => {
          e.preventDefault();
          const errorDiv = document.getElementById('start-shift-error');
          errorDiv.classList.add('d-none');
          const data = {
            loai_ca_id: document.getElementById('loai_ca_id').value,
            tien_mat_ban_dau: document.getElementById('tien_mat_ban_dau').value
          };

          if (!data.loai_ca_id) {
            errorDiv.textContent = 'Vui l√≤ng ch·ªçn m·ªôt ca l√†m vi·ªác.';
            errorDiv.classList.remove('d-none');
            return;
          }

          try {
            const result = await postData('/ca/bat-dau/', data);
            alert(`ƒê√£ b·∫Øt ƒë·∫ßu ${result.loai_ca.ten_ca} th√†nh c√¥ng!`);
            location.reload();
          } catch (error) {
            errorDiv.textContent = `L·ªói: ${error.message}`;
            errorDiv.classList.remove('d-none');
          }
        });
      }

      document.getElementById('debtOffcanvas').addEventListener('shown.bs.offcanvas', () => loadDebtList(true));
      debtListContainer.addEventListener('click', (e) => {
        const btn = e.target.closest('.pay-debt-btn');
        if (btn) payDebt(btn.dataset.id);
      });

      setInterval(() => loadDebtList(false), 60000);

      updateCaInfo();
      setInterval(updateCaInfo, 30000);
    });

    // G·ª≠i form K·∫øt th√∫c ca
const endShiftForm = document.getElementById('endShiftForm');
if (endShiftForm) {
  endShiftForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const actualCash = parseFloat(document.getElementById('end-shift-actual-cash').value) || 0;
    const errDiv = document.getElementById('end-shift-error');
    errDiv.classList.add('d-none');
    try {
      await postData('/ca/ket-thuc/', { tien_mat_thuc_te: actualCash });
      alert('ƒê√£ k·∫øt th√∫c ca th√†nh c√¥ng!');
      window.location.href = '/logout/';
    } catch (error) {
      errDiv.textContent = `L·ªói khi k·∫øt th√∫c ca: ${error.message}`;
      errDiv.classList.remove('d-none');
    }
  });
}

  </script>

  <!-- api_client + bootstrap bundle -->
  <script src="http://127.0.0.1:9000{% static 'js/api_client.js' %}"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  {% block extra_js %}{% endblock %}
  <div class="modal fade" id="endShiftModal" tabindex="-1" aria-labelledby="endShiftModalLabel" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form id="endShiftForm">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="endShiftModalLabel"><i class="bi bi-door-open-fill me-2"></i> K·∫øt Th√∫c Ca L√†m Vi·ªác</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h6>T√≥m t·∫Øt ca l√†m vi·ªác: <span id="end-shift-name" class="text-primary"></span></h6>
                    <hr>
                    <div class="cost-section">
                        <div class="cost-row">
                            <span class="info-label">Ti·ªÅn m·∫∑t ban ƒë·∫ßu (H·ªá th·ªëng):</span>
                            <span id="end-shift-cash-start" class="info-value">0 ƒë</span>
                        </div>
                        <div class="cost-row">
                            <span class="info-label">T·ªïng Doanh Thu (H·ªá th·ªëng):</span>
                            <span id="end-shift-revenue" class="info-value">0 ƒë</span>
                        </div>
                        <div class="cost-row">
                            <span class="info-label">T·ªïng ti·ªÅn m·∫∑t c·∫ßn c√≥ (L√Ω thuy·∫øt):</span>
                            <span id="end-shift-theoretical-total" class="info-value">0 ƒë</span>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="end-shift-actual-cash" class="form-label">S·ªë ti·ªÅn m·∫∑t th·ª±c t·∫ø ƒë·∫øm ƒë∆∞·ª£c</label>
                        <div class="input-group">
                            <input type="number" id="end-shift-actual-cash" class="form-control" min="0" step="1000" required>
                            <span class="input-group-text">VNƒê</span>
                        </div>
                    </div>
                    <div id="end-shift-error" class="alert alert-danger d-none mt-2"></div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-danger w-100"><i class="bi bi-power me-2"></i> CH·ªêT CA & ƒêƒÇNG XU·∫§T</button>
                </div>
            </form>
        </div>
    </div>
</div>
</body>
</html>
